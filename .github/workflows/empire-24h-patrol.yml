name: Empire 24h Non-Stop Patrol

on:
  schedule:
    - cron: '0 * * * *'   # Every hour, 24/7
  workflow_dispatch:
    inputs:
      force_heal:
        description: 'Force self-heal even if no drift'
        required: false
        default: 'false'

concurrency:
  group: empire-24h-patrol
  cancel-in-progress: false

jobs:
  # ── Layer 6: Self-Heal ──────────────────────────────────────
  self-heal:
    name: L6 Self-Heal + L1 Permissions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Layer 1 - Permission Model
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: pwsh scripts/zero-trust/ops-layer1-permission-model.ps1
        continue-on-error: true

      - name: Layer 6 - Self-Heal Patrol
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: pwsh scripts/zero-trust/ops-layer6-self-heal.ps1
        continue-on-error: true

  # ── Layer 3: Policy Enforcement ────────────────────────────
  policy-enforce:
    name: L3 Policy Enforcement (GitHub + Cloudflare + Supabase RLS)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: GitHub Branch Protection
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: pwsh scripts/ai-governance/enforce-github-policy.ps1
        continue-on-error: true

      - name: Cloudflare WAF + TLS
        shell: pwsh
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: pwsh scripts/ai-governance/cloudflare-rules-enforce.ps1
        continue-on-error: true

      - name: Supabase RLS Enforcement
        shell: pwsh
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: pwsh scripts/ai-governance/supabase-rls-enforce.ps1
        continue-on-error: true

  # ── Layer 4: Audit Collection ───────────────────────────────
  audit-collect:
    name: L4 Audit Collection
    runs-on: ubuntu-latest
    needs: [self-heal]
    steps:
      - uses: actions/checkout@v4

      - name: Layer 4 - Immutable Audit
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: pwsh scripts/zero-trust/ops-layer4-immutable-audit.ps1
        continue-on-error: true

  # ── Layer 8: Telegram Alert ─────────────────────────────────
  alert:
    name: L8 Telegram Alert
    runs-on: ubuntu-latest
    needs: [self-heal, policy-enforce, audit-collect]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Send Telegram Status
        shell: pwsh
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          pwsh scripts/zero-trust/ops-layer8-telegram.ps1 -EventType "24h-patrol" -Status "OK" -LookbackMinutes 65
        continue-on-error: true
