name: Azure Self-Heal Patrol
on:
  schedule:
    - cron: '0,15,30,45 * * * *'
  workflow_dispatch:

concurrency:
  group: azure-self-heal
  cancel-in-progress: false

jobs:
  self-heal:
    name: Self-Heal Patrol
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Layer 3 - Self-Heal
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: pwsh scripts/azure-governance/layer3-self-heal-runbook.ps1
      - name: Layer 4 - Audit Collection
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: pwsh scripts/azure-governance/layer4-audit-central.ps1
