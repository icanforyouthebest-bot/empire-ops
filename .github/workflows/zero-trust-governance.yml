name: Zero Trust Ops Officer Governance
on:
  workflow_dispatch:
    inputs:
      layer:
        description: 'Layer (1-6 or all)'
        required: false
        default: 'all'
        type: choice
        options: ['all', '1', '2', '3', '4', '5', '6']
      action:
        description: 'For L5 only: audit | replace | lockout | list'
        required: false
        default: 'audit'
      old_officer:
        description: 'L5 replace: old officer UPN'
        required: false
      new_officer:
        description: 'L5 replace: new officer UPN'
        required: false
      target_upn:
        description: 'L5 lockout: target UPN'
        required: false
      reason:
        description: 'Reason for action'
        required: false
        default: 'routine-governance'

concurrency:
  group: zero-trust-governance
  cancel-in-progress: false

jobs:
  layer1-permission-model:
    name: 'ZT-L1: Permission Model'
    runs-on: ubuntu-latest
    if: github.event.inputs.layer == 'all' || github.event.inputs.layer == '1'
    steps:
      - uses: actions/checkout@v4
      - name: Verify permission model
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run: pwsh scripts/zero-trust/ops-layer1-permission-model.ps1

  layer2-role-template:
    name: 'ZT-L2: Role Template'
    runs-on: ubuntu-latest
    needs: layer1-permission-model
    if: always() && (github.event.inputs.layer == 'all' || github.event.inputs.layer == '2')
    steps:
      - uses: actions/checkout@v4
      - name: Enforce role template
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run: pwsh scripts/zero-trust/ops-layer2-role-template.ps1

  layer4-audit:
    name: 'ZT-L4: Immutable Audit'
    runs-on: ubuntu-latest
    needs: layer2-role-template
    if: always() && (github.event.inputs.layer == 'all' || github.event.inputs.layer == '4')
    steps:
      - uses: actions/checkout@v4
      - name: Collect immutable audit
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: pwsh scripts/zero-trust/ops-layer4-immutable-audit.ps1

  layer5-officer-mgmt:
    name: 'ZT-L5: Officer Management'
    runs-on: ubuntu-latest
    needs: layer4-audit
    if: always() && (github.event.inputs.layer == 'all' || github.event.inputs.layer == '5')
    steps:
      - uses: actions/checkout@v4
      - name: Officer management
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ACTION: ${{ github.event.inputs.action || 'list' }}
          OLD_OFFICER_UPN: ${{ github.event.inputs.old_officer }}
          NEW_OFFICER_UPN: ${{ github.event.inputs.new_officer }}
          TARGET_UPN: ${{ github.event.inputs.target_upn }}
          REASON: ${{ github.event.inputs.reason }}
        run: pwsh scripts/zero-trust/ops-layer5-replace-officer.ps1

  layer6-self-heal:
    name: 'ZT-L6: Self-Heal'
    runs-on: ubuntu-latest
    needs: layer5-officer-mgmt
    if: always() && (github.event.inputs.layer == 'all' || github.event.inputs.layer == '6')
    steps:
      - uses: actions/checkout@v4
      - name: Self-heal patrol
        shell: pwsh
        env:
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: pwsh scripts/zero-trust/ops-layer6-self-heal.ps1
